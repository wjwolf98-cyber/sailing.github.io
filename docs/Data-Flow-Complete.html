<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据流设计完整文档</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            line-height: 1.8;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1890ff;
            border-bottom: 3px solid #1890ff;
            padding-bottom: 10px;
        }
        h2 {
            color: #2c3e50;
            margin-top: 40px;
            border-left: 4px solid #1890ff;
            padding-left: 15px;
        }
        h3 {
            color: #34495e;
            margin-top: 30px;
        }
        h4 {
            color: #555;
            margin-top: 20px;
        }
        pre {
            background-color: #f6f8fa;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            padding: 16px;
            overflow-x: auto;
            line-height: 1.45;
            font-size: 0.9em;
        }
        code {
            background-color: #f6f8fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
        }
        ul, ol {
            padding-left: 30px;
        }
        li {
            margin: 8px 0;
        }
        .mermaid {
            background-color: white;
            padding: 20px;
            border-radius: 6px;
            margin: 20px 0;
            border: 1px solid #e1e4e8;
        }
        .flow-box {
            background-color: #f8f9fa;
            border-left: 4px solid #1890ff;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .section-divider {
            border-top: 2px solid #e1e4e8;
            margin: 60px 0 40px 0;
            position: relative;
        }
        .section-divider::after {
            content: '●';
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 0 20px;
            color: #1890ff;
            font-size: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>数据流设计完整文档</h1>
        <p style="color: #666; font-style: italic;">本文档整合了数据流设计和数据流图表，完整描述品牌保护生态系统中的数据流转过程</p>

        <h2>1. 概述</h2>
        <p>本文档描述品牌保护生态系统中各业务场景的数据流转过程，包括数据的产生、传输、处理、存储和使用。</p>

        <h2>2. 核心数据流</h2>

        <h3>2.1 用户认证数据流</h3>
        <div class="flow-box">
            <pre>用户登录请求
    ↓
API网关 (验证请求格式)
    ↓
认证服务 (auth-service)
    ├─ 查询用户信息 (MySQL: sys_user)
    ├─ 验证密码 (BCrypt)
    ├─ 生成JWT Token
    ├─ 存储Session (Redis)
    └─ 记录登录日志 (MongoDB: login_logs)
    ↓
返回Token给客户端
    ↓
客户端存储Token (LocalStorage/SecureStorage)
    ↓
后续请求携带Token
    ↓
API网关验证Token
    ├─ 解析JWT
    ├─ 验证签名
    ├─ 检查过期时间
    └─ 从Redis获取Session
    ↓
放行请求到业务服务</pre>
        </div>

        <h3>2.2 权限验证数据流</h3>
        <div class="flow-box">
            <pre>业务请求 (携带Token)
    ↓
API网关
    ├─ 提取用户ID
    └─ 提取请求路径
    ↓
认证服务
    ├─ 查询用户角色 (MySQL: sys_user_role)
    ├─ 查询角色权限 (MySQL: sys_role_permission)
    ├─ 缓存权限信息 (Redis: user:permissions:{userId})
    └─ 验证接口权限
    ↓
权限验证结果
    ├─ 有权限 → 放行
    └─ 无权限 → 返回403</pre>
        </div>

        <div class="section-divider"></div>

        <h2>3. 业务数据流</h2>

        <h3>3.1 品牌管理数据流</h3>

        <h4>3.1.1 品牌创建流程</h4>
        <div class="flow-box">
            <pre>生产商提交品牌信息
    ↓
前端表单验证
    ↓
API网关 → brand-service
    ↓
业务逻辑验证
    ├─ 品牌名称唯一性检查
    ├─ 营业执照OCR识别
    └─ 商标证书验证
    ↓
数据持久化
    ├─ 保存品牌信息 (MySQL: brand_info)
    ├─ 保存权属信息 (MySQL: brand_property)
    ├─ 上传Logo到OSS
    └─ 记录操作日志 (MongoDB: operation_logs)
    ↓
发送消息通知
    ├─ RocketMQ: brand.created
    └─ 通知相关人员
    ↓
返回创建结果</pre>
        </div>

        <h4>3.1.2 品牌授权流程</h4>
        <div class="flow-box">
            <pre>生产商发起授权申请
    ↓
brand-service
    ├─ 创建授权记录 (MySQL: brand_authorization)
    ├─ 生成授权编号
    └─ 触发审批流程
    ↓
workflow-service (审批流程)
    ├─ 创建审批实例
    ├─ 分配审批人
    └─ 发送审批通知
    ↓
审批人审批
    ├─ 同意 → 授权生效
    │   ├─ 更新授权状态
    │   ├─ 生成授权书 (PDF)
    │   ├─ 上传到OSS
    │   └─ 通知申请人
    └─ 拒绝 → 授权失败
        └─ 通知申请人
    ↓
授权数据同步
    ├─ 同步到渠道服务
    ├─ 同步到巡查服务
    └─ 更新缓存 (Redis)</pre>
        </div>

        <h3>3.2 巡查业务数据流</h3>

        <h4>3.2.1 任务创建与分配</h4>
        <div class="flow-box">
            <pre>巡查部管理员创建任务
    ↓
inspection-service
    ├─ 验证任务信息
    ├─ 保存任务 (MySQL: inspection_task)
    └─ 任务分配算法
        ├─ 获取可用巡查员
        ├─ 计算距离和工作量
        └─ 智能分配
    ↓
任务分配结果
    ├─ 更新任务状态
    ├─ 保存分配记录
    └─ 发送推送通知
    ↓
巡查员APP接收任务
    ├─ 推送通知 (极光推送)
    ├─ 下载任务详情
    ├─ 下载参考资料
    └─ 缓存到本地 (WatermelonDB)</pre>
        </div>

        <h4>3.2.2 证据采集与上传</h4>
        <div class="flow-box">
            <pre>巡查员现场采集证据
    ↓
移动端APP
    ├─ 拍照/录像/录音
    ├─ 获取GPS定位
    ├─ 添加水印
    ├─ 生成哈希值
    └─ 保存到本地
    ↓
判断网络状态
    ├─ 有网络 → 立即上传
    └─ 无网络 → 加入上传队列
    ↓
上传到服务器
    ↓
file-service
    ├─ 接收文件
    ├─ 压缩处理
    ├─ 上传到OSS
    ├─ 生成缩略图
    └─ 返回文件URL
    ↓
evidence-service
    ├─ 保存证据记录 (MySQL: evidence)
    ├─ 保存元数据 (MongoDB: evidence_metadata)
    └─ 触发区块链存证
    ↓
blockchain-service
    ├─ 计算证据哈希
    ├─ 调用阿里云存证云API
    ├─ 上链到司法链
    ├─ 保存交易哈希
    └─ 生成存证证书
    ↓
更新证据状态
    ├─ 更新存证信息
    ├─ 发送存证成功通知
    └─ 更新缓存</pre>
        </div>

        <h4>3.2.3 巡查报告提交</h4>
        <div class="flow-box">
            <pre>巡查员填写报告
    ↓
移动端APP
    ├─ 选择报告模板
    ├─ AI智能填写
    ├─ 关联证据
    ├─ 电子签名
    └─ 保存草稿 (本地)
    ↓
提交报告
    ↓
inspection-service
    ├─ 验证报告完整性
    ├─ 保存报告 (MySQL: inspection_report)
    ├─ 保存报告内容 (MongoDB: report_content)
    ├─ 关联证据
    └─ 触发审核流程
    ↓
workflow-service
    ├─ 创建审核实例
    ├─ 分配审核人
    └─ 发送审核通知
    ↓
审核人审核
    ├─ 通过 → 报告生效
    │   ├─ 更新报告状态
    │   ├─ 统计数据更新
    │   └─ 通知巡查员
    └─ 驳回 → 要求修改
        ├─ 填写驳回意见
        └─ 通知巡查员
    ↓
数据同步
    ├─ 同步到数据分析服务
    ├─ 更新统计数据
    └─ 更新缓存</pre>
        </div>

        <h3>3.3 法律服务数据流</h3>

        <h4>3.3.1 案件创建流程</h4>
        <div class="flow-box">
            <pre>品牌方/督导部创建案件
    ↓
legal-service
    ├─ 验证案件信息
    ├─ 保存案件 (MySQL: legal_case)
    ├─ 关联证据
    ├─ 关联巡查报告
    └─ 生成案件编号
    ↓
案件分配
    ├─ 智能匹配律师
    │   ├─ 律师专长匹配
    │   ├─ 工作量评估
    │   └─ 地域匹配
    ├─ 分配律师
    └─ 发送通知
    ↓
律师接收案件
    ├─ 查看案件详情
    ├─ 查看证据材料
    └─ 开始办理</pre>
        </div>

        <h4>3.3.2 AI文书生成流程</h4>
        <div class="flow-box">
            <pre>律师发起文书生成
    ↓
legal-service
    ├─ 选择文书模板
    ├─ 填写基本参数
    └─ 调用AI服务
    ↓
ai-service
    ├─ 接收生成请求
    ├─ 调用通义千问API
    ├─ 提取案件信息
    ├─ 提取证据信息
    ├─ 查询法律知识库
    ├─ 生成文书内容
    └─ 返回生成结果
    ↓
legal-service
    ├─ 保存文书 (MySQL: legal_document)
    ├─ 保存文书内容 (MongoDB: document_content)
    ├─ 生成Word/PDF
    ├─ 上传到OSS
    └─ 返回文书URL
    ↓
律师审核修改
    ├─ 在线编辑
    ├─ 保存版本
    └─ 提交审核
    ↓
审核流程
    ├─ 审核通过 → 文书生效
    └─ 审核拒绝 → 修改完善</pre>
        </div>

        <h3>3.4 专家鉴定数据流</h3>

        <h4>3.4.1 鉴定申请流程</h4>
        <div class="flow-box">
            <pre>用户提交鉴定申请
    ↓
expert-service
    ├─ 验证申请信息
    ├─ 保存申请 (MySQL: appraisal_application)
    ├─ 上传商品图片到OSS
    └─ 触发AI预鉴定
    ↓
ai-service
    ├─ 图像识别
    ├─ 与正品对比
    ├─ 计算相似度
    └─ 返回初步结论
    ↓
expert-service
    ├─ 保存AI鉴定结果
    ├─ 智能分配专家
    │   ├─ 专家专长匹配
    │   ├─ 工作量评估
    │   └─ 选择专家
    └─ 发送通知
    ↓
专家鉴定
    ├─ 查看申请详情
    ├─ 查看商品图片
    ├─ 参考AI结论
    ├─ 进行专业鉴定
    └─ 出具鉴定报告
    ↓
鉴定报告
    ├─ 保存报告 (MySQL: appraisal_report)
    ├─ 保存报告内容 (MongoDB)
    ├─ 专家电子签名
    ├─ 生成PDF报告
    ├─ 区块链存证
    └─ 发送给申请人</pre>
        </div>

        <h3>3.5 纠纷处理数据流</h3>

        <h4>3.5.1 调解流程</h4>
        <div class="flow-box">
            <pre>申请人提交调解申请
    ↓
dispute-service
    ├─ 验证申请信息
    ├─ 保存申请 (MySQL: mediation_case)
    ├─ 上传证据材料
    └─ 分配调解员
    ↓
调解员接收案件
    ├─ 查看案件详情
    ├─ 联系双方当事人
    └─ 安排调解时间
    ↓
在线调解
    ├─ 创建RTC房间
    ├─ 发送会议链接
    ├─ 双方进入房间
    ├─ 音视频通话
    ├─ 屏幕共享
    ├─ 实时笔录
    └─ 录制回放
    ↓
调解结果
    ├─ 调解成功
    │   ├─ 生成调解协议
    │   ├─ 双方电子签名
    │   ├─ 区块链存证
    │   └─ 结案
    └─ 调解失败
        ├─ 记录调解过程
        └─ 转仲裁</pre>
        </div>

        <h4>3.5.2 在线庭审数据流</h4>
        <div class="flow-box">
            <pre>仲裁庭安排庭审
    ↓
dispute-service
    ├─ 创建庭审记录
    ├─ 选择庭审时间
    └─ 通知当事人
    ↓
创建RTC房间
    ↓
rtc-service (阿里云RTC)
    ├─ 创建频道
    ├─ 生成Token
    └─ 返回房间信息
    ↓
当事人加入庭审
    ├─ 申请人
    ├─ 被申请人
    ├─ 仲裁员
    └─ 书记员
    ↓
庭审进行
    ├─ 音视频通话
    ├─ 屏幕共享
    ├─ 证据展示
    ├─ 实时笔录
    │   ├─ 语音识别
    │   ├─ 文字转写
    │   └─ 保存笔录
    └─ 全程录制
    ↓
庭审结束
    ├─ 保存录像到OSS
    ├─ 保存笔录 (MongoDB)
    ├─ 当事人签字确认
    ├─ 区块链存证
    └─ 生成庭审记录</pre>
        </div>

        <h3>3.6 商城业务数据流</h3>

        <h4>3.6.1 订单创建流程</h4>
        <div class="flow-box">
            <pre>消费者下单
    ↓
mall-service
    ├─ 验证商品库存
    ├─ 计算订单金额
    ├─ 创建订单 (MySQL: mall_order)
    ├─ 锁定库存 (Redis)
    └─ 返回订单号
    ↓
消费者支付
    ↓
payment-service
    ├─ 调用支付宝/微信API
    ├─ 生成支付二维码
    └─ 等待支付回调
    ↓
支付成功回调
    ↓
payment-service
    ├─ 验证签名
    ├─ 更新支付状态
    └─ 发送消息
    ↓
RocketMQ: order.paid
    ↓
mall-service (消费消息)
    ├─ 更新订单状态
    ├─ 扣减库存
    ├─ 创建发货任务
    └─ 发送通知
    ↓
logistics-service
    ├─ 调用物流API
    ├─ 创建物流单
    └─ 更新物流信息</pre>
        </div>

        <h4>3.6.2 投诉举报流程</h4>
        <div class="flow-box">
            <pre>消费者提交投诉
    ↓
mall-service
    ├─ 验证投诉信息
    ├─ 保存投诉 (MySQL: complaint)
    ├─ 上传证据图片
    └─ 创建工单
    ↓
发送消息
    ↓
RocketMQ: complaint.created
    ↓
inspection-service (消费消息)
    ├─ 创建巡查任务
    ├─ 分配巡查员
    └─ 发送通知
    ↓
巡查员核查
    ├─ 现场核查
    ├─ 采集证据
    └─ 提交报告
    ↓
处理结果
    ├─ 属实 → 立案处理
    └─ 不属实 → 关闭投诉
    ↓
反馈消费者</pre>
        </div>

        <div class="section-divider"></div>

        <h2>4. 数据同步流程</h2>

        <h3>4.1 实时数据同步</h3>
        <div class="flow-box">
            <pre>业务数据变更
    ↓
业务服务
    ├─ 更新MySQL
    └─ 发送MQ消息
    ↓
RocketMQ
    ↓
同步服务 (消费消息)
    ├─ 更新Redis缓存
    ├─ 更新Elasticsearch索引
    └─ 更新MongoDB</pre>
        </div>

        <h3>4.2 离线数据同步</h3>
        <div class="flow-box">
            <pre>定时任务 (XXL-Job)
    ↓
data-sync-service
    ├─ 读取MySQL数据
    ├─ 数据清洗转换
    └─ 写入数据仓库
    ↓
数据仓库 (MaxCompute)
    ├─ 数据建模
    ├─ 数据分析
    └─ 生成报表</pre>
        </div>

        <h3>4.3 移动端数据同步</h3>
        <div class="flow-box">
            <pre>移动端APP
    ↓
检测网络状态
    ├─ 有网络
    │   ├─ 上传本地数据
    │   ├─ 下载服务器数据
    │   └─ 解决冲突
    └─ 无网络
        └─ 本地操作
    ↓
网络恢复
    ↓
自动同步
    ├─ 上传队列数据
    ├─ 下载增量数据
    └─ 更新本地数据库</pre>
        </div>

        <div class="section-divider"></div>

        <h2>5. 数据流监控</h2>

        <h3>5.1 链路追踪</h3>
        <div class="flow-box">
            <pre>请求进入
    ↓
生成TraceId
    ↓
经过各个服务
    ├─ API网关 (Span1)
    ├─ 业务服务 (Span2)
    ├─ 数据库 (Span3)
    └─ 缓存 (Span4)
    ↓
上报到ARMS
    ↓
链路可视化</pre>
        </div>

        <h3>5.2 数据质量监控</h3>
        <div class="flow-box">
            <pre>数据写入
    ↓
数据质量检查
    ├─ 完整性检查
    ├─ 准确性检查
    ├─ 一致性检查
    └─ 时效性检查
    ↓
质量问题
    ├─ 记录问题
    ├─ 发送告警
    └─ 触发修复</pre>
        </div>

        <div class="section-divider"></div>

        <h2>6. 数据安全流程</h2>

        <h3>6.1 数据加密流程</h3>
        <div class="flow-box">
            <pre>敏感数据
    ↓
应用层加密
    ├─ AES-256加密
    └─ 密钥管理
    ↓
传输层加密
    ├─ TLS 1.3
    └─ 证书验证
    ↓
存储层加密
    ├─ 数据库加密
    └─ 文件加密</pre>
        </div>

        <h3>6.2 数据脱敏流程</h3>
        <div class="flow-box">
            <pre>查询敏感数据
    ↓
权限验证
    ├─ 有脱敏权限 → 返回原始数据
    └─ 无脱敏权限 → 数据脱敏
        ├─ 手机号: 138****0000
        ├─ 身份证: 110***********1234
        └─ 银行卡: 6222***********1234
    ↓
返回数据</pre>
        </div>

        <div class="section-divider"></div>

        <h2>7. 数据备份与恢复</h2>

        <h3>7.1 数据备份流程</h3>
        <div class="flow-box">
            <pre>定时任务
    ↓
backup-service
    ├─ 全量备份 (每日)
    │   ├─ MySQL备份
    │   ├─ MongoDB备份
    │   └─ Redis备份
    ├─ 增量备份 (实时)
    │   └─ Binlog备份
    └─ 上传到OSS
    ↓
异地备份
    ├─ 同步到其他区域
    └─ 保留30天</pre>
        </div>

        <h3>7.2 数据恢复流程</h3>
        <div class="flow-box">
            <pre>数据丢失/损坏
    ↓
选择恢复点
    ↓
backup-service
    ├─ 从OSS下载备份
    ├─ 验证备份完整性
    ├─ 恢复数据
    └─ 验证数据正确性
    ↓
恢复完成</pre>
        </div>

        <div class="section-divider"></div>

        <h2>8. 系统级数据流图</h2>

        <h3>8.1 整体数据流架构</h3>
        <div class="mermaid">
graph TB
    subgraph "客户端层"
        A1[管理后台Web]
        A2[移动端APP]
        A3[消费者商城]
    end
    
    subgraph "接入层"
        B1[API网关]
        B2[CDN]
    end
    
    subgraph "业务服务层"
        C1[认证服务]
        C2[品牌服务]
        C3[巡查服务]
        C4[法律服务]
        C5[专家服务]
        C6[纠纷服务]
        C7[商城服务]
        C8[AI服务]
    end
    
    subgraph "数据层"
        D1[(MySQL)]
        D2[(MongoDB)]
        D3[(Redis)]
        D4[(Elasticsearch)]
        D5[OSS]
    end
    
    subgraph "中间件层"
        E1[RocketMQ]
        E2[Nacos]
        E3[Sentinel]
    end
    
    subgraph "外部服务"
        F1[区块链]
        F2[支付]
        F3[物流]
        F4[地图]
    end
    
    A1 --> B1
    A2 --> B1
    A3 --> B1
    B1 --> C1
    B1 --> C2
    B1 --> C3
    B1 --> C4
    B1 --> C5
    B1 --> C6
    B1 --> C7
    B1 --> C8
    
    C1 --> D1
    C2 --> D1
    C3 --> D1
    C4 --> D1
    C5 --> D1
    C6 --> D1
    C7 --> D1
    
    C1 --> D3
    C2 --> D3
    C3 --> D3
    
    C3 --> D2
    C4 --> D2
    C5 --> D2
    
    C2 --> D4
    C3 --> D4
    C7 --> D4
    
    C3 --> D5
    C4 --> D5
    C5 --> D5
    
    C2 --> E1
    C3 --> E1
    C7 --> E1
    
    C3 --> F1
    C7 --> F2
    C7 --> F3
    C3 --> F4
        </div>

        <h3>8.2 数据流向图</h3>
        <div class="mermaid">
graph LR
    A[数据产生] --> B[数据采集]
    B --> C[数据传输]
    C --> D[数据处理]
    D --> E[数据存储]
    E --> F[数据使用]
    F --> G[数据归档]
    
    style A fill:#e1f5ff
    style B fill:#fff4e1
    style C fill:#ffe1f5
    style D fill:#e1ffe1
    style E fill:#f5e1ff
    style F fill:#ffe1e1
    style G fill:#e1e1e1
        </div>

        <div class="section-divider"></div>

        <h2>9. 业务数据流时序图</h2>

        <h3>9.1 巡查业务完整数据流</h3>
        <div class="mermaid">
sequenceDiagram
    participant 管理员
    participant 后台系统
    participant 巡查服务
    participant 巡查员APP
    participant 证据服务
    participant 区块链
    participant OSS
    
    管理员->>后台系统: 创建巡查任务
    后台系统->>巡查服务: 保存任务
    巡查服务->>巡查服务: 智能分配
    巡查服务->>巡查员APP: 推送任务
    
    巡查员APP->>巡查员APP: 接收任务
    巡查员APP->>巡查员APP: 现场采集证据
    巡查员APP->>证据服务: 上传证据
    证据服务->>OSS: 存储文件
    证据服务->>区块链: 存证上链
    区块链-->>证据服务: 返回交易哈希
    证据服务-->>巡查员APP: 上传成功
    
    巡查员APP->>巡查服务: 提交报告
    巡查服务->>巡查服务: 审核报告
    巡查服务-->>巡查员APP: 审核结果
        </div>

        <h3>9.2 案件处理数据流</h3>
        <div class="mermaid">
sequenceDiagram
    participant 品牌方
    participant 法律服务
    participant AI服务
    participant 律师
    participant 区块链
    
    品牌方->>法律服务: 创建案件
    法律服务->>法律服务: 分配律师
    法律服务->>律师: 通知接案
    
    律师->>法律服务: 请求生成文书
    法律服务->>AI服务: 调用AI生成
    AI服务->>AI服务: 分析案情
    AI服务->>AI服务: 生成文书
    AI服务-->>法律服务: 返回文书
    法律服务-->>律师: 返回文书
    
    律师->>法律服务: 提交文书
    法律服务->>区块链: 文书存证
    区块链-->>法律服务: 存证成功
    法律服务-->>律师: 提交成功
        </div>

        <h3>9.3 纠纷调解数据流</h3>
        <div class="mermaid">
sequenceDiagram
    participant 申请人
    participant 纠纷服务
    participant 调解员
    participant RTC服务
    participant 被申请人
    
    申请人->>纠纷服务: 提交调解申请
    纠纷服务->>纠纷服务: 分配调解员
    纠纷服务->>调解员: 通知接案
    
    调解员->>纠纷服务: 安排调解
    纠纷服务->>RTC服务: 创建房间
    RTC服务-->>纠纷服务: 返回房间信息
    
    纠纷服务->>申请人: 发送会议链接
    纠纷服务->>被申请人: 发送会议链接
    
    申请人->>RTC服务: 加入房间
    被申请人->>RTC服务: 加入房间
    调解员->>RTC服务: 加入房间
    
    RTC服务->>RTC服务: 音视频通话
    RTC服务->>RTC服务: 录制回放
    
    调解员->>纠纷服务: 提交调解结果
    纠纷服务->>纠纷服务: 生成协议
    纠纷服务->>申请人: 通知结果
    纠纷服务->>被申请人: 通知结果
        </div>

        <h3>9.4 商城订单数据流</h3>
        <div class="mermaid">
sequenceDiagram
    participant 消费者
    participant 商城服务
    participant 库存服务
    participant 支付服务
    participant 物流服务
    participant MQ
    
    消费者->>商城服务: 创建订单
    商城服务->>库存服务: 检查库存
    库存服务-->>商城服务: 库存充足
    商城服务->>商城服务: 锁定库存
    商城服务-->>消费者: 返回订单
    
    消费者->>支付服务: 发起支付
    支付服务->>支付服务: 调用支付宝
    支付服务-->>消费者: 返回支付二维码
    
    消费者->>支付服务: 完成支付
    支付服务->>MQ: 发送支付成功消息
    
    MQ->>商城服务: 消费消息
    商城服务->>商城服务: 更新订单状态
    商城服务->>库存服务: 扣减库存
    商城服务->>物流服务: 创建物流单
    商城服务->>消费者: 发送通知
        </div>

        <div class="section-divider"></div>

        <h2>10. 数据处理流图</h2>

        <h3>10.1 证据处理流程</h3>
        <div class="mermaid">
graph TD
    A[证据采集] --> B{网络状态}
    B -->|在线| C[立即上传]
    B -->|离线| D[本地存储]
    D --> E[加入队列]
    E --> F{网络恢复}
    F -->|是| C
    F -->|否| E
    
    C --> G[文件上传]
    G --> H[压缩处理]
    H --> I[上传OSS]
    I --> J[生成缩略图]
    J --> K[保存记录]
    K --> L[区块链存证]
    L --> M[生成证书]
    M --> N[通知用户]
    
    style A fill:#e1f5ff
    style C fill:#e1ffe1
    style D fill:#ffe1e1
    style L fill:#f5e1ff
    style M fill:#fff4e1
        </div>

        <h3>10.2 AI文书生成流程</h3>
        <div class="mermaid">
graph TD
    A[发起请求] --> B[选择模板]
    B --> C[填写参数]
    C --> D[调用AI服务]
    
    D --> E[提取案件信息]
    E --> F[提取证据信息]
    F --> G[查询知识库]
    G --> H[调用通义千问]
    H --> I[生成文书内容]
    
    I --> J[格式化处理]
    J --> K[人工审核]
    K --> L{审核结果}
    L -->|通过| M[保存文书]
    L -->|拒绝| N[修改完善]
    N --> K
    
    M --> O[生成PDF]
    O --> P[上传OSS]
    P --> Q[返回结果]
    
    style A fill:#e1f5ff
    style D fill:#ffe1f5
    style H fill:#f5e1ff
    style M fill:#e1ffe1
        </div>

        <div class="section-divider"></div>

        <h2>11. 数据同步流图</h2>

        <h3>11.1 实时数据同步</h3>
        <div class="mermaid">
graph LR
    A[业务服务] -->|写入| B[(MySQL)]
    A -->|发送消息| C[RocketMQ]
    C -->|消费| D[同步服务]
    D -->|更新| E[(Redis)]
    D -->|更新| F[(Elasticsearch)]
    D -->|更新| G[(MongoDB)]
    
    style A fill:#e1f5ff
    style B fill:#fff4e1
    style C fill:#ffe1f5
    style D fill:#e1ffe1
    style E fill:#f5e1ff
    style F fill:#ffe1e1
    style G fill:#e1e1ff
        </div>

        <h3>11.2 移动端离线同步</h3>
        <div class="mermaid">
stateDiagram-v2
    [*] --> 在线模式
    在线模式 --> 离线模式: 网络断开
    离线模式 --> 在线模式: 网络恢复
    
    在线模式: 实时同步
    在线模式: 数据上传
    在线模式: 数据下载
    
    离线模式: 本地操作
    离线模式: 数据缓存
    离线模式: 队列管理
    
    在线模式 --> 同步中: 触发同步
    同步中 --> 在线模式: 同步完成
    
    同步中: 上传队列数据
    同步中: 下载增量数据
    同步中: 冲突解决
        </div>

        <div class="section-divider"></div>

        <h2>12. 数据安全流图</h2>

        <h3>12.1 数据加密流程</h3>
        <div class="mermaid">
graph LR
    A[原始数据] --> B[应用层加密]
    B --> C[传输层加密]
    C --> D[存储层加密]
    
    B -->|AES-256| B1[加密数据]
    C -->|TLS 1.3| C1[安全传输]
    D -->|数据库加密| D1[加密存储]
    
    D1 --> E[读取数据]
    E --> F[解密]
    F --> G[返回数据]
    
    style A fill:#e1f5ff
    style B fill:#ffe1e1
    style C fill:#ffe1f5
    style D fill:#f5e1ff
    style G fill:#e1ffe1
        </div>

        <h3>12.2 权限验证流程</h3>
        <div class="mermaid">
graph TD
    A[用户请求] --> B[提取Token]
    B --> C{Token有效?}
    C -->|否| D[返回401]
    C -->|是| E[提取用户ID]
    
    E --> F[查询用户角色]
    F --> G[查询角色权限]
    G --> H{有权限?}
    H -->|否| I[返回403]
    H -->|是| J[放行请求]
    
    J --> K[执行业务逻辑]
    K --> L[返回结果]
    
    style A fill:#e1f5ff
    style C fill:#ffe1e1
    style H fill:#ffe1e1
    style K fill:#e1ffe1
        </div>

        <div class="section-divider"></div>

        <h2>13. 数据监控流图</h2>

        <h3>13.1 链路追踪流程</h3>
        <div class="mermaid">
graph LR
    A[请求进入] --> B[生成TraceId]
    B --> C[API网关]
    C --> D[业务服务]
    D --> E[数据库]
    D --> F[缓存]
    D --> G[MQ]
    
    C -->|Span1| H[ARMS]
    D -->|Span2| H
    E -->|Span3| H
    F -->|Span4| H
    G -->|Span5| H
    
    H --> I[链路可视化]
    I --> J[性能分析]
    I --> K[异常告警]
    
    style A fill:#e1f5ff
    style B fill:#fff4e1
    style H fill:#f5e1ff
    style I fill:#e1ffe1
        </div>

        <h3>13.2 数据质量监控</h3>
        <div class="mermaid">
graph TD
    A[数据写入] --> B[质量检查]
    
    B --> C{完整性}
    B --> D{准确性}
    B --> E{一致性}
    B --> F{时效性}
    
    C -->|不合格| G[记录问题]
    D -->|不合格| G
    E -->|不合格| G
    F -->|不合格| G
    
    G --> H[发送告警]
    H --> I[触发修复]
    
    C -->|合格| J[数据入库]
    D -->|合格| J
    E -->|合格| J
    F -->|合格| J
    
    style A fill:#e1f5ff
    style B fill:#fff4e1
    style G fill:#ffe1e1
    style J fill:#e1ffe1
        </div>

        <div class="section-divider"></div>

        <h2>14. 数据备份恢复流图</h2>

        <h3>14.1 备份流程</h3>
        <div class="mermaid">
graph TD
    A[定时任务] --> B{备份类型}
    B -->|全量| C[MySQL全量备份]
    B -->|全量| D[MongoDB全量备份]
    B -->|全量| E[Redis全量备份]
    B -->|增量| F[Binlog增量备份]
    
    C --> G[压缩]
    D --> G
    E --> G
    F --> G
    
    G --> H[上传OSS]
    H --> I[异地同步]
    I --> J[验证完整性]
    J --> K[保留30天]
    
    style A fill:#e1f5ff
    style B fill:#fff4e1
    style H fill:#f5e1ff
    style K fill:#e1ffe1
        </div>

        <h3>14.2 恢复流程</h3>
        <div class="mermaid">
graph TD
    A[数据丢失] --> B[选择恢复点]
    B --> C[从OSS下载]
    C --> D[验证完整性]
    D --> E{完整性OK?}
    E -->|否| F[选择其他备份]
    F --> C
    E -->|是| G[解压]
    
    G --> H[恢复MySQL]
    G --> I[恢复MongoDB]
    G --> J[恢复Redis]
    
    H --> K[验证数据]
    I --> K
    J --> K
    
    K --> L{数据正确?}
    L -->|否| M[回滚]
    L -->|是| N[恢复完成]
    
    style A fill:#ffe1e1
    style E fill:#fff4e1
    style L fill:#fff4e1
    style N fill:#e1ffe1
        </div>

        <hr style="margin: 60px 0; border: none; border-top: 2px solid #e1e4e8;">
        <p style="text-align: center; color: #666;">
            <strong>文档版本</strong>: v1.0<br>
            <strong>最后更新</strong>: 2024-01-01<br>
            <strong>文档所有者</strong>: 架构团队<br><br>
            <em>本文档使用Mermaid语法绘制数据流图，可在支持Mermaid的浏览器中查看图表。</em>
        </p>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });
    </script>
</body>
</html>
